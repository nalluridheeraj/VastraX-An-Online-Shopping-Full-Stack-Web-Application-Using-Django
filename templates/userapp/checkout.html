{% extends 'base.html' %}
{% load static %}
{% block title %}Checkout{% endblock %}
{% block page_bg_attr %}style="background-image: url('{% static 'images/collections-bg.jpg' %}');"{% endblock %}
{% block page_wrap_class %}overlay{% endblock %}

{% block content %}
<div class="container page-section">
  <h1 class="section-title">Checkout</h1>
  {% if not user %}
  <p>Please <a href="{% url 'userapp:login' %}">login</a> to place an order.</p>
  {% elif not addresses %}
  <p>Please <a href="{% url 'userapp:addresses' %}">add an address</a> first.</p>
  {% else %}
  <div style="display: grid; grid-template-columns: 1fr 400px; gap: 2rem;">
    <div>
      <h2 style="font-size: 1.1rem; margin-bottom: 0.75rem;">Select Address</h2>
      <form method="post" action="{% url 'userapp:place_order' %}">
        {% csrf_token %}
        {% for addr in addresses %}
        <label class="form-box" style="display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; max-width: 100%;">
          <input type="radio" name="address" value="{{ addr.pk }}" {% if addr.is_default %}checked{% endif %} required>
          <span>{{ addr.full_name }}, {{ addr.address_line1 }}, {{ addr.city }} - {{ addr.pincode }}</span>
        </label>
        {% endfor %}
        <hr style="margin: 1rem 0;">
        <p><strong>Subtotal:</strong> ₹{{ subtotal }}</p>
        <p><strong>Discount:</strong> ₹{{ discount }}</p>
        <p><strong>Total:</strong> ₹{{ total }}</p>
        <button type="submit" class="btn btn-primary" style="margin-top: 1rem;">Place Order & Pay</button>
      </form>
    </div>
    <div>
      <div class="form-box" style="max-width: 100%; margin-bottom: 1rem;">
        <h2 style="font-size: 1.1rem; margin-bottom: 0.75rem;">Order Summary</h2>
        {% for item in items %}
        <p>{{ item.product.name }} × {{ item.quantity }} — ₹{{ item.product.price|floatformat:0 }} × {{ item.quantity }} = ₹{{ item.subtotal }}</p>
        {% endfor %}
      </div>
      <div class="form-box" style="max-width: 100%;">
        <h2 style="font-size: 1.1rem; margin-bottom: 0.75rem;">Apply Coupon</h2>
        <form method="post" action="{% url 'userapp:apply_coupon' %}" style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
          {% csrf_token %}
          <input type="text" name="coupon_code" placeholder="Coupon code" value="{{ request.session.coupon_code }}" style="flex: 1; padding: 0.5rem;">
          <button type="submit" class="btn btn-outline">Apply</button>
        </form>
        {% if request.session.coupon_code %}
        <p style="color: green; margin: 0;">Coupon {{ request.session.coupon_code }} applied. Discount: ₹{{ request.session.coupon_discount }}</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
